<!doctype html>
<html>
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  <!-- Use title if it's in the page YAML frontmatter -->
  <title>Dylan Markow</title>
  <link href="//fonts.googleapis.com/css?family=Roboto:400,700" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="/javascripts/all.js" type="text/javascript"></script>
</head>

<body class="index">
  <div class="container">
    <header class="">
      <h1><a href="/">Dylan Markow</a></h1>
      <hr>
    </header>

    <div class="row">
      <div class="col-md-9">
        <div id="main" role="main">
          
  <h2>
    <a href="/blog/2014/01/08/capistrano-3-setting-a-default-stage/">Capistrano 3: Setting a Default Stage</a>
    <span>
      Jan  8
    </span>
    
  </h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->

  <p>In Capistrano v2, multi-stage support wasn&#39;t built in. If you didn&#39;t need stages, you could just happily
use <code>cap deploy</code> without any problem.</p>

<p>Capistrano v3 is a complete rewrite from v2, and with it comes built-in multi-stage support, even if you don&#39;t want it.
So even if you have just a single stage, let&#39;s say <code>production</code>, you still have to reference the stage every single time
you run your Capistrano tasks:</p>
<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code">cap production deploy
</td></tr></tbody></table></pre>
<p>If you try <code>cap deploy</code> without a stage, you will be told:</p>

<p><em>Stage not set, please call something such as <code>cap production deploy</code>, where production is a stage you have defined.</em></p>

<p>If you used something like the multistage extension in v2, you would expect to be able to add <code>set :default_stage, &quot;production&quot;</code>
to your configuration. You will quickly find that this has no effect in v3, and if you try to run your tasks without specifying
a stage, you&#39;ll get the same error. The <a href="https://github.com/capistrano/capistrano/issues/806">issue has been brought up</a>
but apparently having a single stage isn&#39;t a &quot;use case.&quot; I disagree, so let&#39;s make it work.</p>

<hr>

<p>Time to dig into Capistrano a little. Instead of using its own DSL, Capistrano is now a Rake application.
So what&#39;s really happening is that Capistrano is expecting a separate task for your stage to be run
<strong>before</strong> the <code>deploy</code> task. In fact, the <code>deploy.rb</code> file isn&#39;t even loaded when you run <code>cap deploy</code>
without a stage.</p>

<p>When we look at Capistrano&#39;s <code>lib/capistrano/setup.rb</code> file, we find that the stage tasks do a couple things.
For each stage (the list of stages is created from the files in the <code>config/deploy/</code> directory), a Rake task is defined to:</p>

<ol>
<li>Set the <code>:stage</code></li>
<li>Load the capistrano defaults</li>
<li>Load the <code>deploy.rb</code> file</li>
<li>Load the <code>deploy/#{stage}.rb</code> file</li>
<li>Do a couple other things like setting SCM and locales</li>
</ol>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div><div class="lineno">9</div><div class="lineno">10</div><div class="lineno">11</div><div class="lineno">12</div><div class="lineno">13</div><div class="lineno">14</div><div class="lineno">15</div><div class="lineno">16</div><div class="lineno">17</div><div class="lineno">18</div><div class="lineno">19</div><div class="lineno">20</div></td><td class="code"><span class="c1"># lib/capistrano/setup.rb</span>

<span class="n">namespace</span> <span class="ss">:load</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:defaults</span> <span class="k">do</span>
    <span class="nb">load</span> <span class="s1">&#39;capistrano/defaults.rb&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">stages</span><span class="nf">.each</span> <span class="k">do</span> <span class="o">|</span><span class="n">stage</span><span class="o">|</span>
  <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="nf">.define_task</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">set</span><span class="p">(</span><span class="ss">:stage</span><span class="p">,</span> <span class="n">stage</span><span class="nf">.to_sym</span><span class="p">)</span>

    <span class="n">invoke</span> <span class="s1">&#39;load:defaults&#39;</span>
    <span class="nb">load</span> <span class="n">deploy_config_path</span>
    <span class="nb">load</span> <span class="n">stage_config_path</span><span class="nf">.join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">stage</span><span class="si">}</span><span class="s2">.rb&quot;</span><span class="p">)</span>
    <span class="nb">load</span> <span class="s2">&quot;capistrano/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:scm</span><span class="p">)</span><span class="si">}</span><span class="s2">.rb&quot;</span>
    <span class="no">I18n</span><span class="nf">.locale</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:locale</span><span class="p">,</span> <span class="ss">:en</span><span class="p">)</span>
    <span class="n">configure_backend</span>
  <span class="k">end</span>
<span class="k">end</span>
</td></tr></tbody></table></pre>
<p>Now that we know what the stage tasks do, we need to approach it a little differently. Instead of thinking <em>How do I set a default stage</em>,
we now ask <em>How do I make sure that my production stage&#39;s task is run every time</em>.</p>

<p>Because this is a Rake application, we already know the answer: invoke the <code>production</code> task by default.
Normally you would do this from your <code>Rakefile</code>, but since we&#39;re using Capistrano, you&#39;ll add this to the end of your <code>Capfile</code> instead:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code"><span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="ss">:production</span><span class="o">]</span><span class="nf">.invoke</span>
</td></tr></tbody></table></pre>
<p>We can even use the <code>invoke</code> method from Capistrano&#39;s own DSL:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code"><span class="n">invoke</span> <span class="ss">:production</span>
</td></tr></tbody></table></pre>
<p><strong>Note:</strong> We could have simply added a shell alias such as <code>alias cap=&#39;cap production&#39;</code>, but that has plenty of its own downsides.</p>

<p>Also, this may have some unintended consequences if you actually do use multiple stages, but if you only ever use the production stage, it should work fine.</p>

  <hr>
  <h2>
    <a href="/blog/2013/12/30/jquery-mobile-rails-1-4-0-released/">jQuery Mobile Rails 1.4.0 Released</a>
    <span>
      Dec 30
    </span>
    
      <span class='text-muted'>2013</span>
    
  </h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->

  <p>jQuery Mobile 1.4.0 has been released, so the <a href="https://rubygems.org/gems/jquery_mobile_rails/">jquery_mobile_rails gem</a> has been updated as well!</p>

<p>You can read about the changes on the <a href="http://blog.jquerymobile.com/2013/12/23/jquery-mobile-1-4-0-released/">jQuery Mobile blog</a>.</p>

  <hr>
  <h2>
    <a href="/blog/2013/09/26/jquery-mobile-rails-1-4-0-beta-1-released/">jQuery Mobile Rails 1.4.0.beta.1 Released</a>
    <span>
      Sep 26
    </span>
    
      <span class='text-muted'>2013</span>
    
  </h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->

  <p>I&#39;ve been helping out with maintenance of the <a href="https://github.com/tscolari/jquery-mobile-rails">jquery_mobile_rails gem</a>
and am excited to announce the first <a href="https://rubygems.org/gems/jquery_mobile_rails/versions/1.4.0.beta.1">beta for the upcoming 1.4.0 release</a>.</p>

<p>You can read about the changes on the <a href="http://jquerymobile.com/blog/2013/09/24/announcing-jquery-mobile-1-4-beta/">jQuery Mobile blog</a>.</p>

  <hr>
  <h2>
    <a href="/blog/2013/09/12/speeding-up-rails-4-in-development-mode/">Speeding up Rails 4 in Development Mode</a>
    <span>
      Sep 12
    </span>
    
      <span class='text-muted'>2013</span>
    
  </h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->

  <p>As I&#39;ve been adding more and more CSS/JS files to my Rails app, I&#39;ve been
noticing a huge slowdown in page load times. Most of the assets are tiny
controller-specific files, but the size of those files is irrelevant.</p>

<p>By default, Rails 4.0 turns on &quot;debug mode&quot; for your assets. As a result, every
single page load sends a separate request for each asset. Even though most of
these return a 304 Not Modified header, it still slows things down by having to
send/receive a couple hundred requests.</p>

<p>Simply disabling asset debugging in <code>config/development.rb</code> drastically
improved the page load time in the browser:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div></td><td class="code"><span class="c1"># Debug mode disables concatenation and preprocessing of assets.</span>
<span class="c1"># This option may cause significant delays in view rendering with a large</span>
<span class="c1"># number of complex assets.</span>
<span class="n">config</span><span class="nf">.assets.debug</span> <span class="o">=</span> <span class="kp">false</span>
</td></tr></tbody></table></pre>
<p>Note that this is different from production mode; Rails still
recognizes when you change your assets and will automatically reload them
without needing to restart the server. The primary change is that the
CSS/JS is concatenated into single files.</p>

<p>Before the change, Chrome took around 1.8 seconds to fully load a page. After
the change, 450ms. Development mode feels <strong>much</strong> snappier now!</p>

  <hr>
  <h2>
    <a href="/blog/2012/05/06/load-order-with-rubymotion/">Load Order with RubyMotion</a>
    <span>
      May  6
    </span>
    
      <span class='text-muted'>2012</span>
    
  </h2>
  <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->

  <p>Because of the way <a href="http://www.rubymotion.com">RubyMotion</a> compiles your application, you may run into dependency issues between your ruby files. By default, RubyMotion uses a simple <code>Dir.glob</code> command to load your files:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div></td><td class="code"><span class="no">Dir</span><span class="nf">.glob</span><span class="p">(</span><span class="no">File</span><span class="nf">.join</span><span class="p">(</span><span class="n">app</span><span class="nf">.project_dir</span><span class="p">,</span> <span class="s1">&#39;app/**/*.rb&#39;</span><span class="p">))</span>
</td></tr></tbody></table></pre>
<p>Suppose you create a custom module under <code>app/lib/foo.rb</code> with some convenience methods:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div></td><td class="code"><span class="k">module</span> <span class="nn">Foo</span>
  <span class="k">def </span><span class="nc">self</span><span class="o">.</span><span class="nf">bar</span>
    <span class="s2">&quot;bar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</td></tr></tbody></table></pre>
<p>And then you include it in your <code>AppDelegate</code> class:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div></td><td class="code"><span class="k">class </span><span class="nc">AppDelegate</span>
  <span class="kp">include</span> <span class="no">Foo</span>

  <span class="k">def </span><span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>
    <span class="vi">@bar</span> <span class="o">=</span> <span class="nb">self</span><span class="nf">.bar</span>
    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</td></tr></tbody></table></pre>
<p>When you run <code>rake</code>, you may run into this:</p>
<pre class="highlight text"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div></td><td class="code">(main)&gt;&gt; 2012-05-06 16:58:49.270 app[88253:f803] *** Terminating app due to uncaught exception &#39;NameError&#39;, reason: &#39;uninitialized constant AppDelegate::Foo (NameError)
&#39;
*** First throw call stack:
(0x156a022 0x1b0cd6 0xd1c34 0x2377 0x2225)
terminate called throwing an exception
</td></tr></tbody></table></pre>
<p>The basic solution, which <a href="http://www.rubymotion.com/developer-center/guides/project-management/#_files_dependencies">RubyMotion&#39;s documentation suggests</a>, is to use the <code>app.files_dependencies</code> option in your <code>Rakefile</code>:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div></td><td class="code"><span class="no">Motion</span><span class="o">::</span><span class="no">Project</span><span class="o">::</span><span class="no">App</span><span class="nf">.setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="c1"># Use `rake config&#39; to see complete project settings.</span>
  <span class="n">app</span><span class="nf">.name</span> <span class="o">=</span> <span class="s1">&#39;app&#39;</span>
  <span class="n">app</span><span class="nf">.files_dependencies</span> <span class="s1">&#39;app/app_delegate.rb&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;app/lib/foo.rb&#39;</span>
<span class="k">end</span>
</td></tr></tbody></table></pre>
<p>However, if you are building a large app, and want <code>Foo</code> to be available to all your classes, you probably don&#39;t want to have dozens of <code>&#39;app/baz.rb&#39; =&gt; &#39;app/lib/foo.rb&#39;</code> entries. In my project, I&#39;m just altering the array of files from <code>Dir.glob</code> instead, ensuring my modules get loaded first:</p>
<pre class="highlight ruby"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div></td><td class="code"><span class="n">app</span><span class="nf">.files</span> <span class="o">=</span> <span class="no">Dir</span><span class="nf">.glob</span><span class="p">(</span><span class="no">File</span><span class="nf">.join</span><span class="p">(</span><span class="n">app</span><span class="nf">.project_dir</span><span class="p">,</span> <span class="s1">&#39;app/lib/**/*.rb&#39;</span><span class="p">))</span> <span class="o">|</span>
            <span class="no">Dir</span><span class="nf">.glob</span><span class="p">(</span><span class="no">File</span><span class="nf">.join</span><span class="p">(</span><span class="n">app</span><span class="nf">.project_dir</span><span class="p">,</span> <span class="s1">&#39;app/**/*.rb&#39;</span><span class="p">))</span>
</td></tr></tbody></table></pre>
  <hr>


        </div>
      </div>

      <aside class="col-md-3">

        <div class="panel panel-success">
          <div class="panel-heading">
            <h3 class="panel-title">Find me on...</h3>
          </div>

          <div class="list-group">
            <a class="list-group-item" href="http://github.com/dmarkow"><i class="icon-github icon-large icon-fixed-width"></i> GitHub</a>
            <a class="list-group-item" href="http://twitter.com/dmarkow"><i class="icon-twitter icon-large icon-fixed-width"></i> Twitter</a>
            <a class="list-group-item" href="http://stackoverflow.com/users/424300/dylan-markow"><i class="icon-stackexchange icon-large icon-fixed-width"></i> Stack Overflow</a>
            <a class="list-group-item" href="http://www.linkedin.com/in/dylanmarkow"><i class="icon-linkedin icon-large icon-fixed-width"></i> LinkedIn</a>
          </div>
        </div>

        <div class="panel panel-info">
          <div class="panel-heading">
            <h2 class="panel-title">Recent Articles</h2>
          </div>
          <div class="list-group">
            
              <a class="list-group-item" href="/blog/2014/01/08/capistrano-3-setting-a-default-stage/">Capistrano 3: Setting a Default Stage</a>
            
              <a class="list-group-item" href="/blog/2013/12/30/jquery-mobile-rails-1-4-0-released/">jQuery Mobile Rails 1.4.0 Released</a>
            
              <a class="list-group-item" href="/blog/2013/09/26/jquery-mobile-rails-1-4-0-beta-1-released/">jQuery Mobile Rails 1.4.0.beta.1 Released</a>
            
              <a class="list-group-item" href="/blog/2013/09/12/speeding-up-rails-4-in-development-mode/">Speeding up Rails 4 in Development Mode</a>
            
              <a class="list-group-item" href="/blog/2012/05/06/load-order-with-rubymotion/">Load Order with RubyMotion</a>
            
          </div>
        </div>



        <!-- <h2>Tags</h2>
        <ol>
          
          <li><a href="/blog/tags/rails/">rails</a> (4)</a></li>
          
          <li><a href="/blog/tags/capistrano/">capistrano</a> (1)</a></li>
          
        </ol>
 -->
<!--         <h2>By Year</h2>
        <ol>
          
          <li><a href="/blog/2014/">2014</a> (1)</a></li>
          
          <li><a href="/blog/2013/">2013</a> (3)</a></li>
          
          <li><a href="/blog/2012/">2012</a> (1)</a></li>
          
        </ol> -->
      </aside>
    </div>
  </div>
</body>
</html>
